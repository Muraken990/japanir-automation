name: Daily IR Image Post

on:
  # æœˆ-é‡‘ 11:00 UTC (20:00 JST) ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 11 * * 1-5'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      date:
        description: 'æ—¥ä»˜ï¼ˆYYYYMMDDå½¢å¼ï¼‰'
        required: false
        default: ''

jobs:
  generate-and-post:
    runs-on: ubuntu-latest
    
    steps:
      # ============================================================
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # ============================================================
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # ============================================================
      # ã‚¹ãƒ†ãƒƒãƒ—2: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ============================================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # ============================================================
      # ã‚¹ãƒ†ãƒƒãƒ—3: Chromiumã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆPlaywrightç”¨ï¼‰
      # ============================================================
      - name: Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
      
      # ============================================================
      # ã‚¹ãƒ†ãƒƒãƒ—4: Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # ============================================================
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install requests openai python-dateutil jinja2 playwright tweepy
          playwright install chromium
      
      # ============================================================
      # ã‚¹ãƒ†ãƒƒãƒ—5: æ—¥ä»˜è¨­å®š
      # ============================================================
      - name: Set date
        id: date
        run: |
          if [ -z "${{ github.event.inputs.date }}" ]; then
            # cronã®å ´åˆ: ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆJSTï¼‰
            DATE=$(TZ=Asia/Tokyo date +%Y%m%d)
          else
            # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆ: å…¥åŠ›ã•ã‚ŒãŸæ—¥ä»˜
            DATE="${{ github.event.inputs.date }}"
          fi
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "ğŸ“… å‡¦ç†æ—¥ä»˜: $DATE"
      
      # ============================================================
      # ã‚¹ãƒ†ãƒƒãƒ—6: ç”»åƒç”Ÿæˆ
      # ============================================================
      - name: Generate IR Image
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python 4_IR_ImageGenerator.py \
            --date ${{ steps.date.outputs.date }} \
            --time-start 08:00 \
            --time-end 20:00 \
            -s 2
          
          # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’ç¢ºèª
          if [ -f "japan_ir_highlights_${{ steps.date.outputs.date }}.png" ]; then
            echo "âœ… ç”»åƒç”ŸæˆæˆåŠŸ"
            echo "has_image=true" >> $GITHUB_OUTPUT
            ls -lh japan_ir_highlights_${{ steps.date.outputs.date }}.png
          else
            echo "â„¹ï¸ IRæƒ…å ±ãªã— - æŠ•ç¨¿ã‚¹ã‚­ãƒƒãƒ—"
            echo "has_image=false" >> $GITHUB_OUTPUT
          fi
          
      # ============================================================
      # ã‚¹ãƒ†ãƒƒãƒ—7: XæŠ•ç¨¿
      # ============================================================
      - name: Post to X (Twitter)
        if: steps.generate.outputs.has_image == 'true'
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: |
          python IR-JsonToX-Image.py \
            --date ${{ steps.date.outputs.date }} \
            --time-start 08:00 \
            --time-end 20:00 \
            --image-path japan_ir_highlights_${{ steps.date.outputs.date }}.png
      
      # ============================================================
      # ã‚¹ãƒ†ãƒƒãƒ—8: ã‚¨ãƒ©ãƒ¼é€šçŸ¥ï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰
      # ============================================================
      - name: Send error notification
        if: failure()
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          echo "âŒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—: ${{ steps.date.outputs.date }}"
          # Gmailé€šçŸ¥ã¯ IR-JsonToX-Image.py å†…ã§å‡¦ç†ã•ã‚Œã‚‹
